<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Sankey Chart Example</title>
    <!-- Include the D3.js library -->
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <!-- Include the D3 Sankey plugin -->
    <script src="https://unpkg.com/d3-sankey@0.12.3/dist/d3-sankey.min.js"></script>
    <style>
      #sankey_chart {
        width: 100%;
        height: 500px;
      }

      .node rect {
        cursor: move;
        fill-opacity: 0.9;
        shape-rendering: crispEdges;
      }

      .node text {
        pointer-events: none;
        text-shadow: 0 1px 0 #fff;
      }

      .link {
        fill: none;
        stroke: #000;
        stroke-opacity: 0.2;
      }

      .link:hover {
        stroke-opacity: 0.5;
      }
    </style>
  </head>

  <body>
    <select id="province-select"></select>

    <a href="website.html"
      ><button class="dv1"><span id="dv1">Home Page</span></button></a
    >
    <div id="sankey_chart"></div>

    <script>
      // Set the dimensions and margins of the graph
      var margin = {
          top: 10,
          right: 30,
          bottom: 10,
          left: 30,
        },
        width = 700 - margin.left - margin.right,
        height = 400 - margin.top - margin.bottom;

      // Append the svg object to the body of the page
      var svg = d3
        .select("#sankey_chart")
        .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

      // Set the sankey diagram properties
      var sankey = d3
        .sankey()
        .nodeWidth(36)
        .nodePadding(40)
        .extent([
          [1, 1],
          [width - 1, height - 5],
        ]);

      // Load the data from a CSV file
      d3.csv("Tableau_dataset_copy_114.csv").then(function (fdata) {
        var provinces = Array.from(new Set(fdata.map((d) => d.province)));

        // Populate the dropdown
        var select = d3.select("#province-select");
        select
          .selectAll("option")
          .data(provinces)
          .enter()
          .append("option")
          .text(function (d) {
            return d;
          })
          .attr("value", function (d) {
            return d;
          });

        select.on("change", function () {
          var selectedProvince = d3.select(this).property("value");

          var data = fdata.filter(function (d) {
            return d.province === selectedProvince;
          });
          console.log(data);
          var number_of_wines = 1;

          // Constructs a new Sankey diagram from the specified graph.
          // The graph must be an object with nodes and links arrays.

          var graph = {
            nodes: [],
            links: [],
          };

          function findNodeIndex(nodeName) {
            for (var i = 0; i < graph.nodes.length; i++) {
              if (graph.nodes[i].name === nodeName) return i;
            }
            return -1;
          }
          // Populate the graph nodes and set up the links between varieties and wines
          data.forEach(function (d) {
            var varietyIndex = findNodeIndex(d.variety);
            var wineIndex = findNodeIndex(d.winery);

            if (varietyIndex === -1) {
              graph.nodes.push({
                name: d.variety,
              });
              varietyIndex = graph.nodes.length - 1;
            }
            if (wineIndex === -1) {
              graph.nodes.push({
                name: d.winery,
              });
              wineIndex = graph.nodes.length - 1;
            }

            graph.links.push({
              source: varietyIndex,
              target: wineIndex,
              value: +number_of_wines,
            });
          });

          sankey.nodes(graph.nodes).links(graph.links);

          // Compute the layout (no need to call .layout() or .update())
          sankey();
          console.log(graph.nodes);
          // add in the links
          var link = svg
            .append("g")
            .selectAll(".link")
            .data(graph.links)
            .enter()
            .append("path")
            .attr("class", "link")
            .attr("d", d3.sankeyLinkHorizontal())
            .style("stroke-width", function (d) {
              return Math.max(1, d.width);
            })
            .sort(function (a, b) {
              return b.width - a.width;
            });

          // add the link titles
          link.append("title").text(function (d) {
            return d.source.name + " â†’ " + d.target.name + "\\n" + d.value;
          });

          // add in the nodes
          var node = svg
            .append("g")
            .selectAll(".node")
            .data(graph.nodes)
            .enter()
            .append("g")
            .attr("class", "node")
            .attr("transform", function (d) {
              return "translate(" + d.x0 + "," + d.y0 + ")";
            });

          // add the rectangles for the nodes
          node
            .append("rect")
            .attr("height", function (d) {
              return d.y1 - d.y0;
            })
            .attr("width", sankey.nodeWidth())
            .style("fill", function (d) {
              return (d.color = d3.color("#d3d3d3"));
            })
            .style("stroke", function (d) {
              return d3.rgb(d.color).darker(2);
            })
            .append("title")
            .text(function (d) {
              return d.name + "\\n" + d.value;
            });

          // add in the title for the nodes
          node
            .append("text")
            .attr("x", -6)
            .attr("y", function (d) {
              return (d.y1 - d.y0) / 2;
            })
            .attr("dy", "0.35em")
            .attr("text-anchor", "end")
            .text(function (d) {
              return d.name;
            })
            .filter(function (d) {
              return d.x0 < width / 2;
            })
            .attr("x", 6 + sankey.nodeWidth())
            .attr("text-anchor", "start");
        });
      });
    </script>
  </body>
</html>
